<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOIXIOS - HERETIC TRADER BINANCE RADAR - HELLO ALEX :)) </title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: monospace;
      padding: 2rem;
    }
    h1 {
      font-size: 1.8rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background-color: #111;
    }
    .green { color: lime; }
    .red { color: red; }
    .ema-long { color: #00ffff; font-weight: bold; }
    .ema-short { color: #d900ff; font-weight: bold; }
    .ema-none { color: gray; font-weight: bold; }
    .super-long { background-color: #00ffff33; }
    .super-short { background-color: #d900ff33; }
    select, input[type="text"] {
      margin-left: 1rem;
      padding: 0.4rem;
      background: #111;
      color: white;
      border: 1px solid #555;
    }
    #refresh-counter {
      float: right;
      font-size: 1rem;
      color: yellow;
    }
    .close-price {
      font-weight: bold;
      font-size: 1.3rem;
      display: block;
    }
    .hl-info {
      color: gray;
      font-size: 0.7rem;
    }
    .top-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .refresh-group {
      display: flex;
      align-items: center;
    }
    .refresh-group label {
      margin-right: 0.5rem;
    }
    .export-btn {
      background:#222;
      color:white;
      border:1px solid gray;
      padding:0.3rem 0.8rem;
      margin-left: 1rem;
    }
  </style>
</head>
<body>
  <h1>üöÄ SOIXIOS - HERETIC TRADER BINANCE RADAR - HELLO ALEX :))</h1>

  <div class="top-controls">
    <div class="refresh-group">
      <label>Refresh every:</label>
      <select id="refreshSelector" onchange="setRefreshInterval()">
        <option value="8" selected>8s</option>
        <option value="13">13s</option>
        <option value="60">60s</option>
        <option value="120">120s</option>
      </select>
      <span id="refresh-counter">‚è≥ 15</span>
    </div>
    <button onclick="exportToCSV()" class="export-btn">üì¶ Export CSV</button>
  </div>

  <p>Favorites (comma-separated):</p>
  <input type="text" id="coinInput" value="BTCUSDT,ARCUSDT,ALCHUSDT,FUNUSDT,TRUMPUSDT,XRPUSDT,TSTUSDT" style="width: 100%;" />

  <table id="radar-table">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Close (H-L)</th>
        <th>1M</th>
        <th>3M</th>
        <th>5M</th>
        <th>15M</th>
        <th>1H</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let refreshCountdown = 8;
    let refreshInterval = 8;

    function setRefreshInterval() {
      refreshInterval = parseInt(document.getElementById("refreshSelector").value);
      refreshCountdown = refreshInterval;
    }

    function calcEMA(data, length) {
      const k = 2 / (length + 1);
      let ema = parseFloat(data[0][4]);
      for (let i = 1; i < data.length; i++) {
        ema = data[i][4] * k + ema * (1 - k);
      }
      return parseFloat(ema);
    }

    async function getValidKlines(symbolInput, interval) {
      const testSymbols = [];
      const base = symbolInput.replace(".P", "");
      testSymbols.push(base);
      if (symbolInput.endsWith(".P")) testSymbols.unshift(symbolInput);

      for (let symbol of testSymbols) {
        try {
          let res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=15`);
          let data = await res.json();
          if (Array.isArray(data) && data.length && data[0][0]) return data;
        } catch (e) {}

        try {
          let res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=15`);
          let data = await res.json();
          if (Array.isArray(data) && data.length && data[0][0]) return data;
        } catch (e) {}
      }

      return null;
    }

    async function fetchAllIntervals() {
      const intervals = ["1m", "3m", "5m", "15m", "1h"];
      const manualCoins = document.getElementById("coinInput").value.split(",").map(c => c.trim().toUpperCase()).slice(0, 10);
      const results = [];

      for (let originalSymbol of manualCoins) {
        const row = { symbol: originalSymbol, signals: {}, data: null };
        for (let interval of intervals) {
          const data = await getValidKlines(originalSymbol, interval);
          if (!data) continue;

          const curr = data[data.length - 1];
          const close = parseFloat(curr[4]);
          const high = Math.max(...data.map(d => parseFloat(d[2])));
          const low = Math.min(...data.map(d => parseFloat(d[3])));
          const ema8 = calcEMA(data.slice(-8), 8);
          const ema13 = calcEMA(data.slice(-13), 13);

          let signal = "EMA NONE";
          let signalClass = "ema-none";
          if (close > ema8 && ema8 > ema13) {
            signal = "EMA LONG";
            signalClass = "ema-long";
          } else if (close < ema8 && ema8 < ema13) {
            signal = "EMA SHORT";
            signalClass = "ema-short";
          }

          row.signals[interval] = { signal, signalClass, close, high, low };
          if (!row.data) row.data = data;
        }
        results.push(row);
      }
      renderMultiIntervalTable(results);
    }

    function renderMultiIntervalTable(rows) {
      const tbody = document.querySelector("#radar-table tbody");
      tbody.innerHTML = "";

      rows.forEach(row => {
        const tr = document.createElement("tr");
        const s1 = row.signals["1m"] || {};
        const s3 = row.signals["3m"] || {};
        const s5 = row.signals["5m"] || {};
        const s15 = row.signals["15m"] || {};
        const s1h = row.signals["1h"] || {};

        const close = s3.close || 0;
        const high = s3.high || 0;
        const low = s3.low || 0;

        const superSignal = s1.signal === s3.signal && s3.signal === s5.signal && s5.signal === s15.signal && s15.signal === s1h.signal && s1.signal !== "EMA NONE";
        const superClass = superSignal ? (s1.signal === "EMA LONG" ? "super-long" : "super-short") : "";

        tr.className = superClass;
        tr.innerHTML = `
          <td>${row.symbol}</td>
          <td><span class="close-price">${close.toFixed(6)}</span><span class="hl-info">(H-${high.toFixed(6)},L-${low.toFixed(6)})</span></td>
          <td class="${s1.signalClass || 'ema-none'}">${s1.signal || '---'}</td>
          <td class="${s3.signalClass || 'ema-none'}">${s3.signal || '---'}</td>
          <td class="${s5.signalClass || 'ema-none'}">${s5.signal || '---'}</td>
          <td class="${s15.signalClass || 'ema-none'}">${s15.signal || '---'}</td>
          <td class="${s1h.signalClass || 'ema-none'}">${s1h.signal || '---'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function exportToCSV() {
      const rows = [...document.querySelectorAll("#radar-table tr")];
      const csv = rows.map(row => [...row.querySelectorAll("td,th")].map(cell => cell.innerText).join(",")).join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'soixios_snapshot.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function updateRefreshCounter() {
      refreshCountdown--;
      if (refreshCountdown <= 0) {
        fetchAllIntervals();
        refreshCountdown = refreshInterval;
      }
      document.getElementById("refresh-counter").textContent = `‚è≥ ${refreshCountdown}`;
    }

    setInterval(updateRefreshCounter, 1000);
    fetchAllIntervals();
  </script>
</body>
</html>
